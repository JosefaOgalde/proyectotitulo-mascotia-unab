{% extends 'registro/base.html' %}
{% load registro_extras %}

{% block title %}Bitácora de salud animal - {{ mascota.nombre }}{% endblock %}

{% block extra_css %}
<style>
    .toggle-switch {
        width: 50px;
        height: 24px;
        appearance: none;
        background-color: #ccc;
        border-radius: 12px;
        position: relative;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    .toggle-switch:checked {
        background-color: #3d9eb3;
    }
    .toggle-switch::before {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background-color: white;
        top: 2px;
        left: 2px;
        transition: left 0.3s;
    }
    .toggle-switch:checked::before {
        left: 28px;
    }
    .section-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
        padding-left: 0.5rem;
        border-left: 4px solid;
    }
    .section-header.naranja { border-left-color: #ff9800; }
    .section-header.rojo { border-left-color: #f44336; }
    .section-header.morado { border-left-color: #9c27b0; }
    .section-header.verde { border-left-color: #4caf50; }
    .section-header.azul-claro { border-left-color: #03a9f4; }
    .section-icon {
        font-size: 1.5rem;
        display: none;
    }
    .section-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: #000000;
        margin: 0;
    }
    .resumen-card {
        background-color: #ffffff;
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
        border: 1px solid #e0e0e0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .resumen-item {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 0;
        border-bottom: 1px solid #f0f0f0;
    }
    .resumen-item:last-child {
        border-bottom: none;
    }
    .resumen-label {
        font-weight: 600;
        color: #666;
    }
    .resumen-value {
        color: #000000;
        font-weight: 500;
    }
    .evento-card {
        background-color: #ffffff;
        border: 1px solid #e0e0e0;
        border-radius: 0.75rem;
        padding: 1.25rem;
        margin-bottom: 1rem;
    }
    .evento-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.75rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    .badge-cita { background-color: #3d9eb3; color: #ffffff; }
    .badge-medicacion { background-color: #3d9eb3; color: #ffffff; }
    .badge-curacion { background-color: #3d9eb3; color: #ffffff; }
    .badge-vacuna { background-color: #3d9eb3; color: #ffffff; }
    .badge-desparasitacion { background-color: #3d9eb3; color: #ffffff; }
    .badge-comentario { background-color: #e0e0e0; color: #000000; }
    
    /* Estilos para campos del formulario */
    form input[type="text"],
    form input[type="number"],
    form input[type="date"],
    form select,
    form textarea {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #e0e0e0;
        border-radius: 0.5rem;
        font-size: 0.9rem;
        background-color: #ffffff;
        color: #000000;
    }
    form input:focus,
    form select:focus,
    form textarea:focus {
        outline: none;
        border-color: #3d9eb3;
        box-shadow: 0 0 0 2px rgba(61, 158, 179, 0.1);
    }
    form textarea {
        min-height: 100px;
        resize: vertical;
    }

    @media (max-width: 1024px) {
        .section-header h1 {
            font-size: 2rem !important;
        }
    }

    @media (max-width: 768px) {
        .section-header h1 {
            font-size: 1.75rem !important;
            line-height: 1.3 !important;
        }
        .resumen-card {
            padding: 1.25rem;
        }
        .resumen-item {
            flex-direction: column;
            gap: 0.25rem;
        }
        .section-header {
            flex-wrap: wrap;
        }
        form section > div[style*="grid-template-columns"] {
            grid-template-columns: 1fr !important;
        }
        .section-title {
            font-size: 1.1rem !important;
        }
    }

    @media (max-width: 480px) {
        .section-header h1 {
            font-size: 1.5rem !important;
            line-height: 1.3 !important;
        }
        .section-icon {
            font-size: 1.25rem;
        }
        .resumen-card {
            padding: 1rem;
        }
        .section-title {
            font-size: 1rem !important;
        }
    }
    
    /* Estilos del Footer */
    .site-footer {
        background-color: #f0f9fa;
        padding: 48px 0 24px;
        border-top: 1px solid #d0e8eb;
        margin-top: 3rem;
    }
    
    .footer-inner {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 24px 24px;
        display: grid;
        grid-template-columns: 2fr 1.2fr 1.2fr 1.6fr;
        gap: 32px;
        font-size: 13px;
        color: #555555;
    }
    
    .footer-title {
        font-weight: 700;
        margin-bottom: 12px;
        color: #00a9b4;
        font-size: 14px;
    }
    
    .footer-brand-title {
        font-weight: 800;
        color: #00a9b4;
        margin-bottom: 10px;
        font-size: 16px;
    }
    
    .footer-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .footer-list li {
        margin-bottom: 8px;
    }
    
    .footer-list a {
        color: #555555;
        transition: color 0.2s ease;
        text-decoration: none;
    }
    
    .footer-list a:hover {
        color: #00a9b4;
    }
    
    .footer-contact-item {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
        color: #555555;
    }
    
    .footer-contact-icon {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background-color: #00a9b4;
        color: #ffffff;
        font-size: 12px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    
    .footer-contact-icon svg {
        width: 14px;
        height: 14px;
    }
    
    .footer-bottom {
        border-top: 1px solid #d0e8eb;
        margin-top: 16px;
        padding-top: 24px;
    }
    
    .footer-bottom-inner {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 14px;
        color: #666666;
    }
    
    .footer-socials {
        display: flex;
        gap: 12px;
    }
    
    .social-icon {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background-color: #00a9b4;
        color: #ffffff;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        font-weight: 600;
        transition: background-color 0.2s ease;
        text-decoration: none;
    }
    
    .social-icon:hover {
        background-color: #008491;
    }
    
    .social-icon.instagram {
        background-color: #00a9b4;
    }
    
    .social-icon.instagram:hover {
        background-color: #008491;
    }
    
    @media (max-width: 768px) {
        .footer-inner {
            grid-template-columns: 1fr 1fr;
            row-gap: 32px;
        }
        
        .footer-bottom-inner {
            flex-direction: column;
            gap: 16px;
            text-align: center;
        }
    }
    
    @media (max-width: 600px) {
        .footer-inner {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div style="background-color:#f5f5f5; min-height:100vh; padding:2rem 0;">
    <div style="max-width:1200px; margin:0 auto; width:100%; padding:0 24px;">
        <!-- Header teal con foto de mascota -->
        <div style="background-color:#3d9eb3; padding:1.5rem 2rem; border-radius:0.75rem; margin-bottom:2rem; display:flex; align-items:center; justify-content:space-between; gap:1.5rem; position:relative;">
            <div style="display:flex; align-items:center; gap:1.5rem; flex:1;">
                <!-- Foto circular de la mascota -->
                <div style="width:80px; height:80px; border-radius:50%; background-color:#ffffff; display:flex; align-items:center; justify-content:center; flex-shrink:0; overflow:hidden; border:3px solid #ffffff;">
                    {% if mascota.foto %}
                        <img src="{{ mascota.foto.url }}" alt="{{ mascota.nombre }}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">
                    {% elif mascota.especie == 'perro' %}
                        {% load static %}
                        <img src="{% static 'registro/icons/perro.svg' %}" alt="Perro" style="width:60px; height:60px; object-fit:contain;">
                    {% else %}
                        {% load static %}
                        <img src="{% static 'registro/icons/gato.svg' %}" alt="Gato" style="width:60px; height:60px; object-fit:contain;">
                    {% endif %}
                </div>
                <div>
                    <h1 style="margin:0; font-size:1.5rem; font-weight:700; color:#ffffff; line-height:1.2;">Bitácora de salud animal - {{ mascota.nombre }}</h1>
                    <p style="margin:0.5rem 0 0; font-size:0.95rem; color:#ffffff; opacity:0.95;">{{ mascota.get_especie_display }} • {% if mascota.raza %}{{ mascota.raza }}{% endif %} • {% if mascota.edad %}{{ mascota.edad }}{% endif %}</p>
                </div>
            </div>
            <!-- ID en la esquina superior derecha -->
            <div style="position:absolute; top:1rem; right:2rem;">
                <span style="font-size:0.9rem; font-weight:600; color:#ffffff; opacity:0.9;">{{ ficha.microchip|default:mascota.microchip|default:"M000001" }}</span>
            </div>
        </div>

        {% if ficha.tiene_datos and not mostrar_formulario %}
        <!-- Sección Información Básica - Modo Visualización -->
        <div style="background-color:#ffffff; border-radius:0.75rem; padding:1.5rem; margin-bottom:2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <!-- Primera fila: Fecha de Nacimiento, Edad, Color de Pelaje, Alergias -->
            <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:1rem; margin-bottom:1rem;">
                <div style="background-color:#f5f5f5; border:1px solid #e0e0e0; border-radius:0.5rem; padding:1rem;">
                    <label style="display:block; font-size:0.75rem; font-weight:700; color:#666; margin-bottom:0.5rem; text-transform:uppercase; letter-spacing:0.05em;">FECHA DE NACIMIENTO</label>
                    <p style="margin:0; font-size:0.95rem; color:#000; font-weight:500;">{% if mascota.fecha_nacimiento %}{{ mascota.fecha_nacimiento|date:"d/m/Y" }}{% else %}—{% endif %}</p>
                </div>
                <div style="background-color:#f5f5f5; border:1px solid #e0e0e0; border-radius:0.5rem; padding:1rem;">
                    <label style="display:block; font-size:0.75rem; font-weight:700; color:#666; margin-bottom:0.5rem; text-transform:uppercase; letter-spacing:0.05em;">EDAD</label>
                    <p style="margin:0; font-size:0.95rem; color:#000; font-weight:500;">{% if mascota.edad %}{{ mascota.edad }}{% else %}—{% endif %}</p>
                </div>
                <div style="background-color:#f5f5f5; border:1px solid #e0e0e0; border-radius:0.5rem; padding:1rem;">
                    <label style="display:block; font-size:0.75rem; font-weight:700; color:#666; margin-bottom:0.5rem; text-transform:uppercase; letter-spacing:0.05em;">COLOR DE PELAJE</label>
                    <p style="margin:0; font-size:0.95rem; color:#000; font-weight:500;">{% if mascota.color_pelaje %}{{ mascota.color_pelaje }}{% else %}—{% endif %}</p>
                </div>
                <div style="background-color:#f5f5f5; border:1px solid #e0e0e0; border-radius:0.5rem; padding:1rem;">
                    <label style="display:block; font-size:0.75rem; font-weight:700; color:#666; margin-bottom:0.5rem; text-transform:uppercase; letter-spacing:0.05em;">ALERGIAS</label>
                    <p style="margin:0; font-size:0.95rem; color:#000; font-weight:500;">{% if ficha.alergias and ficha.alergias.strip %}{{ ficha.alergias }}{% else %}No manifiesta{% endif %}</p>
                </div>
            </div>
            
            <!-- Segunda fila: Próxima Visita a Veterinaria, Última Vacuna -->
            <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:1rem;">
                <div style="background-color:#f5f5f5; border:1px solid #e0e0e0; border-radius:0.5rem; padding:1rem; display:flex; align-items:center; justify-content:space-between;">
                    <div>
                        <label style="display:block; font-size:0.75rem; font-weight:700; color:#666; margin-bottom:0.5rem; text-transform:uppercase; letter-spacing:0.05em;">PRÓXIMA VISITA A VETERINARIA</label>
                        <p style="margin:0; font-size:0.95rem; color:#000; font-weight:500;">{% if proxima_visita %}{{ proxima_visita|date:"d/m/Y" }}{% else %}—{% endif %}</p>
                    </div>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2z" fill="#3d9eb3"/>
                    </svg>
                </div>
                <div style="background-color:#f5f5f5; border:1px solid #e0e0e0; border-radius:0.5rem; padding:1rem; display:flex; align-items:center; justify-content:space-between;">
                    <div>
                        <label style="display:block; font-size:0.75rem; font-weight:700; color:#666; margin-bottom:0.5rem; text-transform:uppercase; letter-spacing:0.05em;">ÚLTIMA VACUNA</label>
                        <p style="margin:0; font-size:0.95rem; color:#000; font-weight:500;">{% if ultima_vacuna %}{{ ultima_vacuna.fecha_evento|date:"d/m/Y" }}{% elif vacunas_display == 'Sí' or vacunas_display == 'Al día' %}Al día{% else %}No hay información{% endif %}</p>
                    </div>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" fill="#4caf50"/>
                    </svg>
                </div>
            </div>
        </div>
        
        <!-- Sección Archivos adjuntos -->
        <div style="background-color:#ffffff; border-radius:0.75rem; padding:1.5rem; margin-bottom:2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <div style="display:flex; align-items:center; gap:0.75rem; margin-bottom:1.5rem;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z" fill="#666666"/>
                </svg>
                <h2 style="margin:0; font-size:1.1rem; font-weight:700; color:#3d9eb3;">Archivos adjuntados{% if todos_los_archivos %} ({{ todos_los_archivos|length }}){% endif %}</h2>
            </div>
            
            <!-- Formulario para subir archivos -->
            <form method="post" enctype="multipart/form-data" id="form-archivos-ficha">
                {% csrf_token %}
                <input type="hidden" name="subir_archivo_ficha" value="1" />
                <div style="border:2px dashed #d0d0d0; border-radius:0.5rem; padding:2.5rem; text-align:center; background-color:#ffffff; margin-bottom:1rem;">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin:0 auto 1rem;">
                        <path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z" fill="#d0d0d0"/>
                    </svg>
                    <div style="margin-bottom:0.75rem;">
                        <label for="archivos_ficha" style="color:#3d9eb3; font-weight:700; cursor:pointer; text-decoration:underline; font-size:0.9rem;">Elegir archivos</label>
                        <span style="color:#999; font-size:0.85rem;"> | </span>
                        <span id="archivos-seleccionados" style="color:#999; font-size:0.85rem;">Ningún archivo seleccionado</span>
                        <input type="file" id="archivos_ficha" name="archivos_ficha" multiple accept=".jpg,.jpeg,.png,.gif,.webp,.pdf,.doc,.docx,.txt" style="display:none;" onchange="updateFileLabelAndSubmit(this)">
                    </div>
                    <p style="margin:1rem 0 0; font-size:0.8rem; color:#999; display:flex; align-items:center; justify-content:center; gap:0.5rem; flex-wrap:wrap;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="flex-shrink:0;">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z" fill="#ffc107"/>
                        </svg>
                        <span>Puedes adjuntar imágenes (JPG, PNG, GIF, WEBP) o documentos (PDF, DOC, DOCX, TXT). Máximo 10MB por archivo. Puedes seleccionar múltiples archivos.</span>
                    </p>
                </div>
            </form>
            
            <!-- Lista de archivos adjuntos -->
            <div id="archivos-list" style="margin-top:1.5rem;">
                {% if todos_los_archivos %}
                    {% for item in todos_los_archivos %}
                    {% with archivo=item.archivo evento=item.evento %}
                    <div style="padding:0.75rem 1rem; border:1px solid #e0e0e0; border-radius:0.5rem; margin-bottom:0.5rem; display:flex; align-items:center; justify-content:space-between; background-color:#f5f5f5;">
                        <div style="display:flex; align-items:center; gap:0.75rem; flex:1;">
                            <!-- Icono de documento en celeste -->
                            <div style="width:40px; height:40px; border-radius:0.5rem; background-color:#3d9eb3; display:flex; align-items:center; justify-content:center; flex-shrink:0;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z" fill="#ffffff"/>
                                </svg>
                            </div>
                            <div style="flex:1;">
                                <a href="{{ archivo.archivo.url }}" target="_blank" style="color:#000000; text-decoration:none; font-weight:700; font-size:0.95rem; display:block; margin-bottom:0.25rem;">{{ archivo.nombre }}</a>
                                <p style="margin:0; font-size:0.85rem; color:#666;">{{ archivo.obtener_tamano_display }} • {{ evento.fecha_evento|date:"d-m-Y" }}</p>
                            </div>
                        </div>
                        <!-- Botón X para eliminar -->
                        <button type="button" onclick="eliminarArchivo({{ archivo.id }})" style="background:none; border:none; color:#f44336; font-size:1.25rem; font-weight:700; cursor:pointer; padding:0.25rem 0.5rem; margin-left:0.5rem; flex-shrink:0;" title="Eliminar archivo">×</button>
                    </div>
                    {% endwith %}
                    {% endfor %}
                {% else %}
                <p style="text-align:center; color:#666; padding:2rem;">No hay archivos adjuntos</p>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- Sección Agregar evento a la bitácora -->
        <div style="background-color:#ffffff; border-radius:0.75rem; padding:2rem; margin-bottom:2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h2 style="font-size:1.25rem; font-weight:700; color:#3d9eb3; margin:0 0 1.5rem;">Agregar evento a la bitácora</h2>
            <form method="post" enctype="multipart/form-data" id="form-evento-bitacora">
                {% csrf_token %}
                <input type="hidden" name="guardar_evento_home" value="1" />
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1.5rem; margin-bottom:1.5rem;">
                    <div>
                        <label for="mascota_id_bitacora" style="display:block; font-size:0.9rem; font-weight:600; color:#000000; margin-bottom:0.5rem;">Mascota</label>
                        <select name="mascota_id" id="mascota_id_bitacora" required style="width:100%; padding:0.75rem; border:1px solid #e0e0e0; border-radius:0.5rem; font-size:0.9rem; background-color:#ffffff;">
                            <option value="">Selecciona</option>
                            {% for mascota_item in todas_las_mascotas %}
                            <option value="{{ mascota_item.id }}" {% if mascota_item.id == mascota.id %}selected{% endif %}>{{ mascota_item.nombre }} ({{ mascota_item.get_especie_display }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div style="position:relative;">
                        <label for="id_fecha_evento_bitacora" style="display:block; font-size:0.9rem; font-weight:600; color:#000000; margin-bottom:0.5rem;">Fecha Evento</label>
                        <input type="date" name="fecha_evento" id="id_fecha_evento_bitacora" required style="width:100%; padding:0.75rem; border:1px solid #e0e0e0; border-radius:0.5rem; font-size:0.9rem; background-color:#ffffff; padding-right:2.5rem;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="position:absolute; right:0.75rem; top:2.5rem; pointer-events:none;">
                            <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2z" fill="#666666"/>
                        </svg>
                    </div>
                </div>
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1.5rem; margin-bottom:1.5rem;">
                    <div style="position:relative;">
                        <label for="{{ evento_form.hora_evento.id_for_label }}_bitacora" style="display:block; font-size:0.9rem; font-weight:600; color:#000000; margin-bottom:0.5rem;">Hora</label>
                        <input type="time" name="{{ evento_form.hora_evento.name }}" id="{{ evento_form.hora_evento.id_for_label }}_bitacora" style="width:100%; padding:0.75rem; border:1px solid #e0e0e0; border-radius:0.5rem; font-size:0.9rem; background-color:#ffffff; padding-right:2.5rem;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="position:absolute; right:0.75rem; top:2.5rem; pointer-events:none;">
                            <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z" fill="#666666"/>
                        </svg>
                    </div>
                    <div>
                        <label for="{{ evento_form.tipo_evento.id_for_label }}_bitacora" style="display:block; font-size:0.9rem; font-weight:600; color:#000000; margin-bottom:0.5rem;">Tipo de Evento</label>
                        <select name="{{ evento_form.tipo_evento.name }}" id="{{ evento_form.tipo_evento.id_for_label }}_bitacora" required style="width:100%; padding:0.75rem; border:1px solid #e0e0e0; border-radius:0.5rem; font-size:0.9rem; background-color:#ffffff;">
                            <option value="">Selecciona</option>
                            {% for choice in evento_form.tipo_evento.field.choices %}
                            {% if choice.0 %}
                            <option value="{{ choice.0 }}">{{ choice.1 }}</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div style="margin-bottom:1.5rem;">
                    <label for="{{ evento_form.veterinario.id_for_label }}_bitacora" style="display:block; font-size:0.9rem; font-weight:600; color:#000000; margin-bottom:0.5rem;">Veterinario</label>
                    <input type="text" name="{{ evento_form.veterinario.name }}" id="{{ evento_form.veterinario.id_for_label }}_bitacora" value="{{ evento_form.veterinario.value|default:'' }}" placeholder="Nombre del veterinario" style="width:100%; padding:0.75rem; border:1px solid #e0e0e0; border-radius:0.5rem; font-size:0.9rem; background-color:#ffffff;">
                </div>
                
                <div style="margin-bottom:1.5rem;">
                    <label for="{{ evento_form.descripcion.id_for_label }}_bitacora" style="display:block; font-size:0.9rem; font-weight:600; color:#000000; margin-bottom:0.5rem;">Descripción</label>
                    <textarea name="{{ evento_form.descripcion.name }}" id="{{ evento_form.descripcion.id_for_label }}_bitacora" rows="4" placeholder="Descripción del evento, observaciones..." style="width:100%; padding:0.75rem; border:1px solid #e0e0e0; border-radius:0.5rem; font-size:0.9rem; background-color:#ffffff; resize:vertical; font-family:inherit;">{{ evento_form.descripcion.value|default:'' }}</textarea>
                </div>
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1.5rem; margin-bottom:1.5rem;">
                    <div>
                        <label for="{{ evento_form.medicacion.id_for_label }}_bitacora" style="display:block; font-size:0.9rem; font-weight:600; color:#000000; margin-bottom:0.5rem;">Medicación</label>
                        <textarea name="{{ evento_form.medicacion.name }}" id="{{ evento_form.medicacion.id_for_label }}_bitacora" rows="4" placeholder="Medicamentos, dosis, frecuencia... (opcional)" style="width:100%; padding:0.75rem; border:1px solid #e0e0e0; border-radius:0.5rem; font-size:0.9rem; background-color:#ffffff; resize:vertical; font-family:inherit;">{{ evento_form.medicacion.value|default:'' }}</textarea>
                    </div>
                    <div>
                        <label for="{{ evento_form.consideraciones.id_for_label }}_bitacora" style="display:block; font-size:0.9rem; font-weight:600; color:#000000; margin-bottom:0.5rem;">Consideraciones</label>
                        <textarea name="{{ evento_form.consideraciones.name }}" id="{{ evento_form.consideraciones.id_for_label }}_bitacora" rows="4" placeholder="Consideraciones especiales, observaciones, recomendaciones... (opcional)" style="width:100%; padding:0.75rem; border:1px solid #e0e0e0; border-radius:0.5rem; font-size:0.9rem; background-color:#ffffff; resize:vertical; font-family:inherit;">{{ evento_form.consideraciones.value|default:'' }}</textarea>
                    </div>
                </div>
                
                <div style="display:flex; justify-content:flex-end; gap:1rem; margin-top:2rem;">
                    <button type="button" onclick="document.getElementById('form-evento-bitacora').reset();" style="background-color:#e0e0e0; color:#333333; border:none; padding:0.75rem 1.5rem; border-radius:0.5rem; font-weight:600; cursor:pointer; font-size:0.9rem;">
                        Cancelar
                    </button>
                    <button type="submit" style="background-color:#3d9eb3; color:#ffffff; border:none; padding:0.75rem 1.5rem; border-radius:0.5rem; font-weight:600; cursor:pointer; font-size:0.9rem;">
                        Agregar Evento
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Sección de Recordatorios / Calendario -->
        <section id="calendario" data-mes-actual="{{ fecha_calendario.month }}" data-anio-actual="{{ fecha_calendario.year }}" style="background-color:#ffffff; border-radius:0.7rem; padding:1.2rem; border:1px solid #e0e0e0; position:relative; max-width:100%; margin-bottom:2rem;">
            <div style="margin-bottom:1rem; position:relative;">
                <p style="font-size:0.85rem; text-transform:uppercase; letter-spacing:0.05em; font-weight:700; margin:0 0 0.5rem; color:#3d9eb3;">PRÓXIMAS CITAS</p>
                <h2 style="font-size:1.25rem; font-weight:600; color:#000000; margin:0 0 0.5rem;">Recordatorios importantes de {{ mascota.nombre }}</h2>
                {% if total_eventos_mes > 0 %}
                <p style="font-size:0.9rem; color:#666; margin:0;">Tienes {{ total_eventos_mes }} evento{{ total_eventos_mes|pluralize }} registrado{{ total_eventos_mes|pluralize }}. Expande las semanas para ver los detalles.</p>
                {% else %}
                <p style="font-size:0.9rem; color:#666; margin:0;">No hay citas registradas. <span style="color:#3d9eb3; cursor:pointer;" onclick="abrirModalEventos();">Añade tus próximas visitas al veterinario para verlas aquí.</span></p>
                {% endif %}
                <button type="button" onclick="abrirModalEventos();" style="position:absolute; top:0; right:0; background-color:#3d9eb3; color:#ffffff; border:none; border-radius:0.35rem; padding:0.75rem 1.25rem; font-weight:600; font-size:0.9rem; cursor:pointer; display:flex; align-items:center; gap:0.5rem;">
                    <span>+</span>
                    <span>Agregar Evento</span>
                </button>
            </div>
            
            <!-- Calendario -->
            <div style="background-color:#b3e5f0; border-radius:0.75rem; padding:0; overflow:hidden;">
                <!-- Navegación de mes -->
                <div style="background-color:#3d9eb3; padding:0.75rem 1rem; display:flex; align-items:center; justify-content:space-between;">
                    <button type="button" id="btn-mes-anterior" style="background-color:rgba(255,255,255,0.2); border:1px solid #ffffff; border-radius:0.375rem; color:#ffffff; font-size:2rem; font-weight:700; cursor:pointer; padding:0.5rem 1rem; min-width:50px; display:flex; align-items:center; justify-content:center; transition:background-color 0.2s;" onmouseover="this.style.backgroundColor='rgba(255,255,255,0.3)'" onmouseout="this.style.backgroundColor='rgba(255,255,255,0.2)'">‹</button>
                    <h3 id="mes-actual" style="color:#ffffff; font-size:1.35rem; font-weight:700; margin:0; text-transform:capitalize;">{{ current_month }}</h3>
                    <button type="button" id="btn-mes-siguiente" style="background-color:rgba(255,255,255,0.2); border:1px solid #ffffff; border-radius:0.375rem; color:#ffffff; font-size:2rem; font-weight:700; cursor:pointer; padding:0.5rem 1rem; min-width:50px; display:flex; align-items:center; justify-content:center; transition:background-color 0.2s;" onmouseover="this.style.backgroundColor='rgba(255,255,255,0.3)'" onmouseout="this.style.backgroundColor='rgba(255,255,255,0.2)'">›</button>
                </div>
                
                <!-- Semanas del mes -->
                <div style="padding:0.5rem; display:flex; flex-direction:column; gap:0.5rem;">
                    {% for par in weeks_paired %}
                    {% with semana=par.0 meta=par.1 semana_idx=forloop.counter0 %}
                    <div style="background-color:#ffffff; border-radius:0.35rem; border:1px solid #e0e0e0; overflow:hidden;">
                        <button type="button" class="btn-accordion-semana" data-target="semana-{{ forloop.counter }}" style="width:100%; text-align:left; background:none; border:none; padding:1rem 1.25rem; display:flex; align-items:center; gap:0.75rem; cursor:pointer;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="flex-shrink:0;">
                                <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2z" fill="#3d9eb3"/>
                            </svg>
                            <strong style="color:#000000; font-size:0.95rem; font-weight:700;">Semana {{ meta.index }}</strong>
                            <span style="color:#666; font-size:0.85rem;">{{ meta.inicio }} - {{ meta.fin }}</span>
                            <span style="margin-left:auto; color:#666; font-size:0.9rem;" class="chevron-semana-{{ forloop.counter }}">▼</span>
                        </button>
                        <div id="semana-{{ forloop.counter }}" class="accordion-body-semana" style="display:none; border-top:1px solid #e0e0e0; padding:0.5rem; position:relative;">
                            <div style="position:relative; padding-top:2.5rem;">
                                <button type="button" class="btn-agregar-evento-semana" data-semana="{{ forloop.counter }}" style="position:absolute; top:0; right:0; background-color:#3d9eb3; color:#ffffff; border:none; border-radius:0.25rem; padding:0.5rem 1rem; font-weight:600; font-size:0.85rem; cursor:pointer; display:flex; align-items:center; gap:0.5rem; z-index:10;">
                                    <span>+</span>
                                    <span>Agregar evento</span>
                                </button>
                                <div style="display:grid; grid-template-columns:repeat(7, minmax(0, 1fr)); gap:0.5rem; max-width:100%; justify-items:center;">
                                    {% for numero in semana %}
                                    <div class="dia-calendario" data-dia-numero="{{ numero }}" data-mes-calendario="{{ fecha_calendario.month }}" data-anio-calendario="{{ fecha_calendario.year }}" style="background-color:#f5f5f5; border:1px solid #e0e0e0; border-radius:0.375rem; padding:0.4rem 0.5rem; text-align:center; width:100%; min-height:3.5rem; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; cursor:pointer; transition:background-color 0.2s;" onmouseover="this.style.backgroundColor='#e8f4f6'" onmouseout="this.style.backgroundColor='#f5f5f5'">
                                        {% if numero %}
                                        <span style="font-size:0.7rem; color:#666; margin-bottom:0.15rem;">
                                            {% if forloop.counter == 1 %}Dom{% elif forloop.counter == 2 %}Lun{% elif forloop.counter == 3 %}Mar{% elif forloop.counter == 4 %}Mié{% elif forloop.counter == 5 %}Jue{% elif forloop.counter == 6 %}Vie{% elif forloop.counter == 7 %}Sáb{% endif %}
                                        </span>
                                        <span style="font-size:1rem; font-weight:700; color:#3d9eb3;">{{ numero }}</span>
                                        {% with eventos_del_dia=eventos_por_dia|get_item:numero %}
                                        {% if eventos_del_dia %}
                                        <div style="display:flex; flex-direction:column; gap:0.25rem; margin-top:0.35rem; width:100%; align-items:stretch;">
                                            {% for evento in eventos_del_dia %}
                                            <div style="display:flex; align-items:center; gap:0.3rem; padding:0.25rem 0.4rem; border-radius:0.25rem; font-size:0.6rem; font-weight:600; background-color:{% if evento.tipo == 'cita_general' or evento.tipo == 'cita_especialista' %}#3d9eb3{% elif evento.tipo == 'vacuna' or evento.tipo == 'medicacion' %}#4caf50{% else %}#3d9eb3{% endif %}; color:#ffffff; width:100%;">
                                                {% if evento.tipo == 'cita_general' or evento.tipo == 'cita_especialista' %}
                                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" fill="#ffffff"/>
                                                </svg>
                                                {% elif evento.tipo == 'vacuna' or evento.tipo == 'medicacion' %}
                                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z" fill="#ffffff"/>
                                                </svg>
                                                {% else %}
                                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" fill="#ffffff"/>
                                                </svg>
                                                {% endif %}
                                                <span style="flex:1; text-align:left;">{{ evento.tipo_display }}</span>
                                                <span>{% if evento.hora %}{{ evento.hora }}{% else %}--:--{% endif %}</span>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                        {% endwith %}
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endwith %}
                    {% endfor %}
                </div>
            </div>
        </section>
        
        {# Historial listado eliminado para que solo se vea el bloque de Registros y el formulario #}

        {% if mostrar_formulario %}
        <form method="post" enctype="multipart/form-data" style="background-color:#ffffff; border-radius:1.5rem; padding:2.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom:2rem;">
            {% csrf_token %}
            <input type="hidden" name="guardar_ficha" value="1" />

            <div style="display:grid; gap:2rem;">
                <section>
                    <div class="section-header naranja">
                        <h2 class="section-title" style="font-size:1.1rem; font-weight:700;">Información Básica</h2>
                    </div>
                    
                    <!-- Campo para subir foto de la mascota -->
                    <div style="margin-bottom:1.5rem; padding:1rem; border:2px dashed #3d9eb3; border-radius:0.5rem; background-color:#f0f9fa;">
                        <label style="display:block; font-size:0.9rem; font-weight:600; color:#000000; margin-bottom:0.5rem;">Foto de la Mascota</label>
                        {% if mascota.foto %}
                        <div style="margin-bottom:0.75rem;">
                            <img src="{{ mascota.foto.url }}" alt="{{ mascota.nombre }}" style="width:120px; height:120px; border-radius:50%; object-fit:cover; border:3px solid #3d9eb3; display:block;">
                        </div>
                        {% endif %}
                        <input type="file" name="foto_mascota" id="foto_mascota" accept="image/*" style="width:100%; padding:0.5rem; border:1px solid #3d9eb3; border-radius:0.5rem; font-size:0.85rem;">
                        <p style="margin:0.5rem 0 0; font-size:0.75rem; color:#666;">Sube una foto de tu mascota. Se mostrará en todas las visualizaciones.</p>
                    </div>
                    
                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:1.5rem;">
                        <div>
                            <label style="display:block; font-size:0.9rem; font-weight:600; color:#000000; margin-bottom:0.5rem;">ID FichaClínica (PK)</label>
                            <input type="text" value="{% if ficha.id %}{{ ficha.id }}{% else %}Auto-generado{% endif %}" disabled style="background-color:#f5f5f5; border:1px solid #ddd; border-radius:0.5rem; padding:0.75rem; width:100%; color:#666;">
                        </div>
                        <div>
                            <label for="{{ ficha_form.microchip.id_for_label }}" style="display:block; font-size:0.9rem; font-weight:600; color:#000000; margin-bottom:0.5rem;">ID Mascota</label>
                            {{ ficha_form.microchip }}
                            {% if ficha_form.microchip.errors %}
                                <p style="color:#ed99c5; font-size:0.8rem; margin-top:0.25rem;">{{ ficha_form.microchip.errors.0 }}</p>
                            {% endif %}
                        </div>
                        {% if not es_nuevo_registro or not ficha.historial_registros.exists %}
                        <div>
                            <label style="display:block; font-size:0.9rem; font-weight:600; color:#000000; margin-bottom:0.5rem;">Fecha de Nacimiento</label>
                            <input type="date" value="{{ mascota.fecha_nacimiento|date:'Y-m-d' }}" disabled style="background-color:#f5f5f5; border:1px solid #ddd; border-radius:0.5rem; padding:0.75rem; width:100%; color:#666;">
                        </div>
                        {% endif %}
                        {% if not tipo_sangre_oculto %}
                        <div>
                            <label for="{{ ficha_form.tipo_sangre.id_for_label }}" style="display:block; font-size:0.9rem; font-weight:600; color:#000000; margin-bottom:0.5rem;">Tipo de Sangre</label>
                            {{ ficha_form.tipo_sangre }}
                            {% if ficha_form.tipo_sangre.errors %}
                                <p style="color:#ed99c5; font-size:0.8rem; margin-top:0.25rem;">{{ ficha_form.tipo_sangre.errors.0 }}</p>
                            {% endif %}
                        </div>
                        {% else %}
                        {{ ficha_form.tipo_sangre }}
                        {% endif %}
                    </div>
                </section>

                <section>
                    <div class="section-header naranja">
                        <h2 class="section-title" style="font-size:1.1rem; font-weight:700;">Signos Vitales</h2>
                    </div>
                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:1.5rem;">
                        <div>
                            <label for="{{ ficha_form.peso.id_for_label }}" style="display:block; font-size:0.9rem; font-weight:600; color:#000000; margin-bottom:0.5rem;">Peso (kg)</label>
                            {{ ficha_form.peso }}
                            {% if ficha_form.peso.help_text %}
                                <p style="font-size:0.8rem; color:#666; margin-top:0.25rem;">{{ ficha_form.peso.help_text }}</p>
                            {% endif %}
                            {% if ficha_form.peso.errors %}
                                <p style="color:#ed99c5; font-size:0.8rem; margin-top:0.25rem;">{{ ficha_form.peso.errors.0 }}</p>
                            {% endif %}
                        </div>
                        <div>
                            <label for="{{ ficha_form.temperatura.id_for_label }}" style="display:block; font-size:0.9rem; font-weight:600; color:#000000; margin-bottom:0.5rem;">Temperatura (°C)</label>
                            {{ ficha_form.temperatura }}
                            {% if ficha_form.temperatura.help_text %}
                                <p style="font-size:0.8rem; color:#666; margin-top:0.25rem;">{{ ficha_form.temperatura.help_text }}</p>
                            {% endif %}
                            {% if ficha_form.temperatura.errors %}
                                <p style="color:#ed99c5; font-size:0.8rem; margin-top:0.25rem;">{{ ficha_form.temperatura.errors.0 }}</p>
                            {% endif %}
                            <div style="display:flex; align-items:center; gap:0.5rem; margin-top:0.5rem;">
                                {{ ficha_form.no_tengo_temperatura }}
                                <label for="{{ ficha_form.no_tengo_temperatura.id_for_label }}" style="font-size:0.85rem; color:#666; cursor:pointer;">No tengo esta información</label>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <div class="section-header rojo">
                        <h2 class="section-title" style="font-size:1.1rem; font-weight:700;">Estado Clínico</h2>
                    </div>
                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:1.5rem;">
                        {% if not esterilizado_oculto %}
                        <div>
                            <label for="{{ ficha_form.esterilizado.id_for_label }}" style="display:block; font-size:0.9rem; font-weight:600; color:#000000; margin-bottom:0.5rem;">Esterilizado</label>
                            {{ ficha_form.esterilizado }}
                            {% if ficha_form.esterilizado.errors %}
                                <p style="color:#ed99c5; font-size:0.8rem; margin-top:0.25rem;">{{ ficha_form.esterilizado.errors.0 }}</p>
                            {% endif %}
                        </div>
                        {% else %}
                        {{ ficha_form.esterilizado }}
                        {% endif %}
                        <div>
                            <label for="{{ ficha_form.vacunas_estado.id_for_label }}" style="display:block; font-size:0.9rem; font-weight:600; color:#000000; margin-bottom:0.5rem;">Vacunas</label>
                            {{ ficha_form.vacunas_estado }}
                            {% if ficha_form.vacunas_estado.errors %}
                                <p style="color:#ed99c5; font-size:0.8rem; margin-top:0.25rem;">{{ ficha_form.vacunas_estado.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>
                    <div id="ultima-vacuna-fields" style="display:none; margin-top:1.5rem;">
                        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:1.5rem;">
                            <div id="vacuna-otra-texto-field" style="display:none;">
                                <label for="{{ ficha_form.vacuna_otra_texto.id_for_label }}" style="display:block; font-size:0.9rem; font-weight:600; color:#000000; margin-bottom:0.5rem;">Especificar otra vacuna</label>
                                {{ ficha_form.vacuna_otra_texto }}
                                {% if ficha_form.vacuna_otra_texto.errors %}
                                    <p style="color:#ed99c5; font-size:0.8rem; margin-top:0.25rem;">{{ ficha_form.vacuna_otra_texto.errors.0 }}</p>
                                {% endif %}
                            </div>
                            <div>
                                <label for="{{ ficha_form.ultima_vacuna_fecha.id_for_label }}" style="display:block; font-size:0.9rem; font-weight:600; color:#000000; margin-bottom:0.5rem;">Fecha de la Última Vacuna</label>
                                {{ ficha_form.ultima_vacuna_fecha }}
                                {% if ficha_form.ultima_vacuna_fecha.help_text %}
                                    <p style="font-size:0.8rem; color:#666; margin-top:0.25rem;">{{ ficha_form.ultima_vacuna_fecha.help_text }}</p>
                                {% endif %}
                                {% if ficha_form.ultima_vacuna_fecha.errors %}
                                    <p style="color:#ed99c5; font-size:0.8rem; margin-top:0.25rem;">{{ ficha_form.ultima_vacuna_fecha.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <div class="section-header naranja">
                        <h2 class="section-title" style="font-size:1.1rem; font-weight:700;">Alergias</h2>
                    </div>
                    <p style="font-size:0.85rem; color:#666; margin-bottom:0.75rem; font-style:italic;">Describe las alergias conocidas de tu mascota. Escribe "No tengo información" o "N/A" si no conoces esta información.</p>
                    <div style="background-color:#ffffff; border:1px solid #e0e0e0; border-radius:0.5rem; padding:0.75rem;">
                        {{ ficha_form.alergias }}
                    </div>
                </section>

                <section>
                    <div class="section-header morado">
                        <h2 class="section-title" style="font-size:1.1rem; font-weight:700;">Condiciones Crónicas</h2>
                    </div>
                    <p style="font-size:0.85rem; color:#666; margin-bottom:0.75rem; font-style:italic;">Ej: Diabetes, carditis, problemas cardiacos. Escribe "No tengo información" o "N/A" si no conoces esta información.</p>
                    <div style="background-color:#ffffff; border:1px solid #e0e0e0; border-radius:0.5rem; padding:0.75rem;">
                        {{ ficha_form.condiciones_cronicas }}
                    </div>
                </section>

                <section>
                    <div class="section-header rojo">
                        <h2 class="section-title" style="font-size:1.1rem; font-weight:700;">Tratamiento</h2>
                    </div>
                    <p style="font-size:0.85rem; color:#666; margin-bottom:0.5rem; font-weight:600;">Medicamentos Actuales</p>
                    <p style="font-size:0.85rem; color:#666; margin-bottom:0.75rem; font-style:italic;">Ingrese medicamentos, dosis y frecuencias. Escribe "No tengo información" o "N/A" si no conoces esta información.</p>
                    <div style="background-color:#ffffff; border:1px solid #e0e0e0; border-radius:0.5rem; padding:0.75rem;">
                        {{ ficha_form.medicamentos_actuales }}
                    </div>
                </section>

                <section>
                    <div class="section-header verde">
                        <h2 class="section-title" style="font-size:1.1rem; font-weight:700;">Historial de Enfermedades</h2>
                    </div>
                    <p style="font-size:0.85rem; color:#666; margin-bottom:0.75rem; font-style:italic;">Indicador de enfermedades pasadas y tratamientos. Escribe "No tengo información" o "N/A" si no conoces esta información.</p>
                    <div style="background-color:#ffffff; border:1px solid #e0e0e0; border-radius:0.5rem; padding:0.75rem;">
                        {{ ficha_form.historial_enfermedades }}
                    </div>
                </section>

                <section>
                    <div class="section-header azul-claro">
                        <h2 class="section-title" style="font-size:1.1rem; font-weight:700;">Comentarios Adicionales</h2>
                    </div>
                    <p style="font-size:0.85rem; color:#666; margin-bottom:0.75rem; font-style:italic;">Observaciones generales sobre la salud de tu mascota.</p>
                    <div style="background-color:#ffffff; border:1px solid #e0e0e0; border-radius:0.5rem; padding:0.75rem;">
                        {{ ficha_form.comentarios }}
                    </div>
                </section>
            </div>

            {% if ficha_form.non_field_errors %}
                <div style="margin-top:1.5rem; padding:1rem; background-color:#f5f5f5; border:1px solid #666; border-radius:0.5rem;">
                    <p style="color:#666; margin:0;">{{ ficha_form.non_field_errors }}</p>
                </div>
            {% endif %}

            <div style="display:flex; justify-content:flex-end; gap:1rem; margin-top:2.5rem; padding-top:2rem; border-top:1px solid #e0e0e0;">
                <button type="button" onclick="document.querySelector('form').reset();" style="background-color:#e0e0e0; color:#333333; border:1px solid #e0e0e0; padding:0.75rem 1.5rem; border-radius:0.5rem; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:0.5rem;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" fill="#333333"/>
                    </svg>
                    <span>Limpiar</span>
                </button>
                <button type="submit" style="background-color:#3d9eb3; color:#ffffff; border:none; padding:0.75rem 2rem; border-radius:0.5rem; font-weight:700; cursor:pointer; display:flex; align-items:center; gap:0.5rem;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z" fill="#ffffff"/>
                    </svg>
                    <span>Guardar Bitácora</span>
                </button>
            </div>
        </form>
        {% endif %}

        <!-- Historial Clínico con Filtros -->
        <section style="background:#fff; border:2px solid #a8e3e1; border-radius:0.75rem; padding:1.5rem; margin-bottom:2rem;">
            <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:1rem; color:#1aa3b0; font-weight:800;">
                <span>📋</span>
                <span style="font-size:1.2rem;">Historial Clínico</span>
            </div>
            
            <!-- Filtros -->
            <form method="get" style="background:#f7fafb; border:1px solid #e3eef0; border-radius:0.5rem; padding:1rem; margin-bottom:1rem;">
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:1rem; align-items:end;">
                    <div>
                        <label for="fecha_desde" style="display:block; margin-bottom:0.25rem; font-weight:700; color:#000; font-size:0.85rem;">Fecha desde:</label>
                        <input type="date" id="fecha_desde" name="fecha_desde" value="{{ filtro_fecha_desde }}" style="width:100%; padding:0.5rem; border:1px solid #e3eef0; border-radius:0.5rem; font-size:0.9rem;">
                    </div>
                    <div>
                        <label for="fecha_hasta" style="display:block; margin-bottom:0.25rem; font-weight:700; color:#000; font-size:0.85rem;">Fecha hasta:</label>
                        <input type="date" id="fecha_hasta" name="fecha_hasta" value="{{ filtro_fecha_hasta }}" style="width:100%; padding:0.5rem; border:1px solid #e3eef0; border-radius:0.5rem; font-size:0.9rem;">
                    </div>
                    <div>
                        <label for="tipo_evento" style="display:block; margin-bottom:0.25rem; font-weight:700; color:#000; font-size:0.85rem;">Tipo de evento:</label>
                        <select id="tipo_evento" name="tipo_evento" style="width:100%; padding:0.5rem; border:1px solid #e3eef0; border-radius:0.5rem; font-size:0.9rem;">
                            <option value="">Todos los tipos</option>
                            {% for value, label in tipos_evento_choices %}
                                <option value="{{ value }}" {% if filtro_tipo_evento == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div style="display:flex; gap:0.5rem;">
                        <button type="submit" style="flex:1; background:#3d9eb3; color:#fff; border:none; border-radius:0.5rem; padding:0.5rem 1rem; font-weight:700; cursor:pointer; font-size:0.9rem;">
                            Filtrar
                        </button>
                        <a href="{% url 'bitacora_mascota' mascota.id %}" style="display:inline-flex; align-items:center; justify-content:center; background:#e0e0e0; color:#000; border:none; border-radius:0.5rem; padding:0.5rem 1rem; font-weight:700; text-decoration:none; font-size:0.9rem;">
                            Limpiar
                        </a>
                    </div>
                </div>
            </form>
            
            <!-- Lista de eventos -->
            {% if eventos_con_archivos %}
                {% for item in eventos_con_archivos %}
                    {% with evento=item.evento archivos=item.archivos %}
                    <div class="evento-card" style="margin-bottom:1rem;">
                        <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:0.75rem; flex-wrap:wrap; gap:0.5rem;">
                            <div>
                                <span class="evento-badge badge-{{ evento.tipo_evento }}">{{ evento.get_tipo_evento_display }}</span>
                                <div style="font-weight:700; color:#000; margin-top:0.25rem;">{{ evento.fecha_evento|date:"d/m/Y" }}</div>
                            </div>
                            {% if evento.veterinario %}
                                <div style="color:#666; font-size:0.9rem;">👨‍⚕️ {{ evento.veterinario }}</div>
                            {% endif %}
                        </div>
                        
                        {% if evento.descripcion %}
                            <div style="margin-bottom:0.5rem; color:#000;">
                                <strong>Descripción:</strong> {{ evento.descripcion }}
                            </div>
                        {% endif %}
                        
                        {% if evento.diagnostico %}
                            <div style="margin-bottom:0.5rem; color:#000;">
                                <strong>Diagnóstico:</strong> {{ evento.diagnostico }}
                            </div>
                        {% endif %}
                        
                        {% if evento.medicacion %}
                            <div style="margin-bottom:0.5rem; color:#000;">
                                <strong>Medicación:</strong> {{ evento.medicacion }}
                            </div>
                        {% endif %}
                        
                        {% if evento.consideraciones %}
                            <div style="margin-bottom:0.5rem; color:#000;">
                                <strong>Consideraciones:</strong> {{ evento.consideraciones }}
                            </div>
                        {% endif %}
                        
                        {% if archivos %}
                            <div style="margin-top:0.75rem; padding-top:0.75rem; border-top:1px solid #e3eef0;">
                                <strong style="display:block; margin-bottom:0.5rem; color:#000;">Archivos adjuntos:</strong>
                                <div style="display:flex; flex-wrap:wrap; gap:0.5rem;">
                                    {% for archivo in archivos %}
                                        <div style="background:#f7fafb; border:1px solid #e3eef0; border-radius:0.5rem; padding:0.5rem; display:inline-flex; align-items:center; gap:0.5rem;">
                                            {% if archivo.es_imagen %}
                                                <span>🖼️</span>
                                            {% else %}
                                                <span>📄</span>
                                            {% endif %}
                                            <a href="{{ archivo.archivo.url }}" target="_blank" style="color:#1aa3b0; text-decoration:none; font-weight:600; font-size:0.85rem;">
                                                {{ archivo.nombre }}
                                            </a>
                                            <span style="color:#666; font-size:0.75rem;">({{ archivo.obtener_tamano_display }})</span>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    {% endwith %}
                {% endfor %}
            {% else %}
                <p style="text-align:center; color:#666; padding:2rem;">No hay eventos clínicos registrados{% if filtro_fecha_desde or filtro_fecha_hasta or filtro_tipo_evento %} con los filtros aplicados{% endif %}.</p>
            {% endif %}
        </section>

    </div>
</div>

<!-- Footer -->
<footer class="site-footer">
    <div class="footer-inner">
        <div class="footer-col">
            <div class="footer-brand-title">mascotia.app</div>
            <p>Bitácora Digital de Salud Animal para Tutores. Centraliza el historial clínico de tus mascotas.</p>
        </div>
        <div class="footer-col">
            <div class="footer-title">Enlaces rápidos</div>
            <ul class="footer-list">
                <li><a href="{% url 'inicio' %}">Inicio</a></li>
                <li><a href="{% url 'home' %}">Panel</a></li>
                <li><a href="#">Sobre Nosotros</a></li>
                <li><a href="#">Servicios</a></li>
                <li><a href="#">Preguntas Frecuentes</a></li>
            </ul>
        </div>
        <div class="footer-col">
            <div class="footer-title">Soporte</div>
            <ul class="footer-list">
                <li><a href="#">Centro de Ayuda</a></li>
                <li><a href="#">Términos y Condiciones</a></li>
                <li><a href="#">Política de Privacidad</a></li>
                <li><a href="#">Contacto</a></li>
            </ul>
        </div>
        <div class="footer-col">
            <div class="footer-title">Contacto</div>
            <div class="footer-contact-item">
                <span class="footer-contact-icon">@</span>
                <span>josefa@mascotia.app</span>
            </div>
            <div class="footer-contact-item">
                <span class="footer-contact-icon">
                    <svg viewBox="0 0 24 24" fill="white" width="14" height="14" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 5.13 15.87 2 12 2ZM12 11.5C10.62 11.5 9.5 10.38 9.5 9C9.5 7.62 10.62 6.5 12 6.5C13.38 6.5 14.5 7.62 14.5 9C14.5 10.38 13.38 11.5 12 11.5Z"/>
                    </svg>
                </span>
                <span>Santiago, Chile</span>
            </div>
        </div>
    </div>
    <div class="footer-bottom">
        <div class="footer-bottom-inner">
            <span>© 2024 Mascotia.app. Todos los derechos reservados.</span>
            <div class="footer-socials">
                <a href="#" class="social-icon">f</a>
                <a href="#" class="social-icon instagram">IG</a>
                <a href="#" class="social-icon">in</a>
                <a href="#" class="social-icon">X</a>
            </div>
        </div>
    </div>
</footer>

<script>
function updateFileLabel(input) {
    const fileCount = input.files.length;
    const labelElement = document.getElementById('archivos-seleccionados');
    if (fileCount > 0 && labelElement) {
        labelElement.textContent = `${fileCount} archivo${fileCount > 1 ? 's' : ''} seleccionado${fileCount > 1 ? 's' : ''}`;
        labelElement.style.color = '#3d9eb3';
        labelElement.style.fontWeight = '600';
    } else if (labelElement) {
        labelElement.textContent = 'Ningún archivo seleccionado';
        labelElement.style.color = '#999';
        labelElement.style.fontWeight = 'normal';
    }
}

function updateFileLabelAndSubmit(input) {
    updateFileLabel(input);
    // Enviar automáticamente el formulario cuando se seleccionan archivos
    if (input.files.length > 0) {
        const form = document.getElementById('form-archivos-ficha');
        if (form) {
            form.submit();
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Manejar campo de fecha de vacuna y campo "Otra"
    const vacunasEstado = document.getElementById('id_vacunas_estado');
    const ultimaVacunaFields = document.getElementById('ultima-vacuna-fields');
    const fechaVacunaField = document.getElementById('id_ultima_vacuna_fecha');
    const vacunaOtraTextoField = document.getElementById('vacuna-otra-texto-field');
    const vacunaOtraTextoInput = document.getElementById('id_vacuna_otra_texto');
    
    if (vacunasEstado && ultimaVacunaFields && fechaVacunaField) {
        function toggleFechaVacuna() {
            const valor = vacunasEstado.value;
            const vacunasEspecificas = ['Polivalente', 'Antirrábica', 'Bordetella', 'Leptospirosis', 
                                      'Parvovirus', 'Moquillo', 'Hepatitis', 'Otra',
                                      'Triple felina', 'Leucemia felina', 'Peritonitis infecciosa',
                                      'Rinotraqueitis', 'Calicivirus', 'Panleucopenia'];
            
            if (vacunasEspecificas.includes(valor)) {
                ultimaVacunaFields.style.display = 'block';
                fechaVacunaField.disabled = false;
                fechaVacunaField.style.backgroundColor = '';
                fechaVacunaField.style.cursor = '';
                
                // Mostrar campo de texto si es "Otra"
                if (valor === 'Otra' && vacunaOtraTextoField && vacunaOtraTextoInput) {
                    vacunaOtraTextoField.style.display = 'block';
                    vacunaOtraTextoInput.style.display = 'block';
                    vacunaOtraTextoInput.removeAttribute('disabled');
                } else if (vacunaOtraTextoField && vacunaOtraTextoInput) {
                    vacunaOtraTextoField.style.display = 'none';
                    vacunaOtraTextoInput.style.display = 'none';
                    vacunaOtraTextoInput.value = '';
                }
            } else {
                ultimaVacunaFields.style.display = 'none';
                fechaVacunaField.disabled = true;
                fechaVacunaField.style.backgroundColor = '#f5f5f5';
                fechaVacunaField.style.cursor = 'not-allowed';
                fechaVacunaField.value = '';
                if (vacunaOtraTextoField && vacunaOtraTextoInput) {
                    vacunaOtraTextoField.style.display = 'none';
                    vacunaOtraTextoInput.value = '';
                }
            }
        }
        
        // Aplicar estado inicial
        toggleFechaVacuna();
        
        vacunasEstado.addEventListener('change', toggleFechaVacuna);
    }
    

    // Manejar checkbox "No tengo temperatura"
    const noTengoTemperatura = document.getElementById('no_tengo_temperatura');
    const temperaturaInput = document.getElementById('id_temperatura');
    
    if (noTengoTemperatura && temperaturaInput) {
        function toggleTemperaturaInput() {
            if (noTengoTemperatura.checked) {
                temperaturaInput.disabled = true;
                temperaturaInput.value = '';
                temperaturaInput.style.backgroundColor = '#f5f5f5';
                temperaturaInput.style.cursor = 'not-allowed';
            } else {
                temperaturaInput.disabled = false;
                temperaturaInput.style.backgroundColor = '';
                temperaturaInput.style.cursor = '';
            }
        }
        
        // Aplicar estado inicial
        toggleTemperaturaInput();
        
        // Escuchar cambios
        noTengoTemperatura.addEventListener('change', toggleTemperaturaInput);
    }
    
    // Función para actualizar la etiqueta de archivos seleccionados y enviar el formulario
    window.updateFileLabelAndSubmit = function(input) {
        const files = input.files;
        const label = document.getElementById('archivos-seleccionados');
        if (label) {
            if (files.length === 0) {
                label.textContent = 'Ningún archivo seleccionado';
            } else if (files.length === 1) {
                label.textContent = files[0].name;
            } else {
                label.textContent = files.length + ' archivos seleccionados';
            }
        }
        // Enviar formulario automáticamente
        if (files.length > 0) {
            document.getElementById('form-archivos-ficha').submit();
        }
    };
});

// ========== JAVASCRIPT PARA EL CALENDARIO ==========
// Funciones globales para el modal de eventos
window.abrirModalEventos = function(fechaSeleccionada) {
    const modalEventosBackdrop = document.getElementById('modal-eventos-backdrop');
    if (modalEventosBackdrop) {
        modalEventosBackdrop.style.display = 'flex';
        // Si se proporciona una fecha, establecerla en el campo de fecha
        if (fechaSeleccionada) {
            const fechaInput = document.getElementById('id_fecha_evento');
            if (fechaInput) {
                fechaInput.value = fechaSeleccionada;
            }
        }
    }
};

window.cerrarModalEventos = function() {
    const modalEventosBackdrop = document.getElementById('modal-eventos-backdrop');
    if (modalEventosBackdrop) {
        modalEventosBackdrop.style.display = 'none';
        // Limpiar formulario
        const form = document.getElementById('form-evento-calendario');
        if (form) {
            form.reset();
        }
    }
};

window.cerrarModalEventoExitoso = function() {
    const modalEventoExitoso = document.getElementById('modal-evento-exitoso');
    if (modalEventoExitoso) {
        modalEventoExitoso.style.display = 'none';
    }
};

// Funciones para el modal de editar información básica
function abrirModalEditarInfoBasica() {
    const modal = document.getElementById('modal-editar-info-backdrop');
    if (modal) {
        modal.style.display = 'flex';
    }
}

function cerrarModalEditarInfoBasica() {
    const modal = document.getElementById('modal-editar-info-backdrop');
    if (modal) {
        modal.style.display = 'none';
    }
}

// Cerrar modal al hacer clic fuera
document.addEventListener('DOMContentLoaded', function() {
    const modalBackdrop = document.getElementById('modal-editar-info-backdrop');
    if (modalBackdrop) {
        modalBackdrop.addEventListener('click', function(e) {
            if (e.target === modalBackdrop) {
                cerrarModalEditarInfoBasica();
            }
        });
    }
    
    // Manejar checkbox de temperatura
    const noTengoTempCheckbox = document.getElementById('modal_no_tengo_temperatura');
    const temperaturaInput = document.getElementById('modal_temperatura');
    if (noTengoTempCheckbox && temperaturaInput) {
        noTengoTempCheckbox.addEventListener('change', function() {
            if (this.checked) {
                temperaturaInput.disabled = true;
                temperaturaInput.value = '';
                temperaturaInput.style.backgroundColor = '#e0e0e0';
            } else {
                temperaturaInput.disabled = false;
                temperaturaInput.style.backgroundColor = '#f5f5f5';
            }
        });
        // Aplicar estado inicial
        if (noTengoTempCheckbox.checked) {
            temperaturaInput.disabled = true;
            temperaturaInput.style.backgroundColor = '#e0e0e0';
        }
    }
});

// Función para eliminar archivo
function eliminarArchivo(archivoId) {
    if (confirm('¿Estás seguro de que deseas eliminar este archivo?')) {
        // Crear un formulario para enviar la solicitud de eliminación
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "bitacora_mascota" mascota.id %}';
        
        // Agregar token CSRF
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken.value;
            form.appendChild(csrfInput);
        }
        
        // Agregar campo para identificar la acción
        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'eliminar_archivo';
        actionInput.value = '1';
        form.appendChild(actionInput);
        
        // Agregar ID del archivo
        const archivoInput = document.createElement('input');
        archivoInput.type = 'hidden';
        archivoInput.name = 'archivo_id';
        archivoInput.value = archivoId;
        form.appendChild(archivoInput);
        
        // Enviar formulario
        document.body.appendChild(form);
        form.submit();
    }
}

// Inicializar calendario cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', function() {
    const calendarioSection = document.getElementById('calendario');
    if (!calendarioSection) return;
    
    // Navegación de meses del calendario con AJAX
    const btnMesAnterior = document.getElementById('btn-mes-anterior');
    const btnMesSiguiente = document.getElementById('btn-mes-siguiente');
    
    function actualizarCalendario(mes, anio) {
        if (!calendarioSection) return;
        
        // Actualizar variables globales
        window.calendarioMesActual = mes;
        window.calendarioAnioActual = anio;
        
        // Mostrar indicador de carga
        const calendarioContent = calendarioSection.querySelector('div[style*="background-color:#b3e5f0"]');
        if (calendarioContent) {
            calendarioContent.style.transition = 'opacity 0.2s';
            calendarioContent.style.opacity = '0.7';
        }
        
        // Hacer petición AJAX
        const url = `{% url 'bitacora_mascota' mascota.id %}?mes=${mes}&anio=${anio}`;
        
        fetch(url)
            .then(response => {
                if (!response.ok) throw new Error('Error en la respuesta');
                return response.text();
            })
            .then(html => {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                const nuevoCalendario = tempDiv.querySelector('#calendario');
                
                if (nuevoCalendario) {
                    const scrollPosition = window.pageYOffset;
                    
                    calendarioSection.innerHTML = nuevoCalendario.innerHTML;
                    
                    requestAnimationFrame(() => {
                        window.scrollTo(0, scrollPosition);
                    });
                    
                    inicializarCalendario();
                }
            })
            .catch(error => {
                console.error('Error al cargar el calendario:', error);
                window.location.href = url;
            })
            .finally(() => {
                if (calendarioContent) {
                    calendarioContent.style.opacity = '1';
                }
            });
    }
    
    function inicializarCalendario() {
        // Acordeones de semanas
        document.querySelectorAll('.btn-accordion-semana').forEach(function(btn) {
            btn.onclick = function() {
                const targetId = btn.getAttribute('data-target');
                const target = document.getElementById(targetId);
                if (!target) return;
                
                const chevronSelector = targetId.replace('semana-', '');
                const chevron = btn.querySelector('.chevron-semana-' + chevronSelector) || btn.querySelector('span:last-child');
                
                const isVisible = target.style.display === 'block';
                target.style.display = isVisible ? 'none' : 'block';
                if (chevron) {
                    chevron.textContent = isVisible ? '▼' : '▲';
                }
            };
        });
        
        // Botones agregar evento
        document.querySelectorAll('.btn-agregar-evento-semana').forEach(function(btn) {
            btn.onclick = function(e) {
                e.stopPropagation();
                if (typeof abrirModalEventos === 'function') {
                    abrirModalEventos();
                }
            };
        });
        
        // Días clickeables
        document.querySelectorAll('.dia-calendario').forEach(function(diaEl) {
            diaEl.onclick = function(e) {
                e.stopPropagation();
                const diaNumero = diaEl.getAttribute('data-dia-numero');
                if (diaNumero && diaNumero !== '') {
                    const mes = diaEl.getAttribute('data-mes-calendario') || window.calendarioMesActual || new Date().getMonth() + 1;
                    const anio = diaEl.getAttribute('data-anio-calendario') || window.calendarioAnioActual || new Date().getFullYear();
                    const fechaSeleccionada = `${anio}-${String(mes).padStart(2, '0')}-${String(diaNumero).padStart(2, '0')}`;
                    window.abrirModalEventos(fechaSeleccionada);
                }
            };
        });
        
        // Botones de navegación
        const nuevoAnterior = document.getElementById('btn-mes-anterior');
        const nuevoSiguiente = document.getElementById('btn-mes-siguiente');
        
        if (nuevoAnterior && nuevoSiguiente) {
            nuevoAnterior.onclick = function(e) {
                e.preventDefault();
                let mes = window.calendarioMesActual;
                let anio = window.calendarioAnioActual;
                
                mes -= 1;
                if (mes < 1) {
                    mes = 12;
                    anio -= 1;
                }
                
                actualizarCalendario(mes, anio);
            };
            
            nuevoSiguiente.onclick = function(e) {
                e.preventDefault();
                let mes = window.calendarioMesActual;
                let anio = window.calendarioAnioActual;
                
                mes += 1;
                if (mes > 12) {
                    mes = 1;
                    anio += 1;
                }
                
                actualizarCalendario(mes, anio);
            };
        }
    }
    
    // Inicializar variables globales desde atributos data
    const calendarioEl = document.getElementById('calendario');
    window.calendarioMesActual = calendarioEl ? parseInt(calendarioEl.getAttribute('data-mes-actual')) || new Date().getMonth() + 1 : new Date().getMonth() + 1;
    window.calendarioAnioActual = calendarioEl ? parseInt(calendarioEl.getAttribute('data-anio-actual')) || new Date().getFullYear() : new Date().getFullYear();
    
    if (btnMesAnterior && btnMesSiguiente) {
        btnMesAnterior.addEventListener('click', function(e) {
            e.preventDefault();
            let mes = window.calendarioMesActual;
            let anio = window.calendarioAnioActual;
            
            mes -= 1;
            if (mes < 1) {
                mes = 12;
                anio -= 1;
            }
            
            actualizarCalendario(mes, anio);
        });
        
        btnMesSiguiente.addEventListener('click', function(e) {
            e.preventDefault();
            let mes = window.calendarioMesActual;
            let anio = window.calendarioAnioActual;
            
            mes += 1;
            if (mes > 12) {
                mes = 1;
                anio += 1;
            }
            
            actualizarCalendario(mes, anio);
        });
        
        inicializarCalendario();
    }
    
    // Modal de eventos - event listeners
    const modalEventosBackdrop = document.getElementById('modal-eventos-backdrop');
    const cerrarModalEventosBtn = document.getElementById('cerrar-modal-eventos');
    const cancelarModalEventosBtn = document.getElementById('cancelar-modal-eventos');
    
    if (cerrarModalEventosBtn) {
        cerrarModalEventosBtn.addEventListener('click', window.cerrarModalEventos);
    }
    
    if (cancelarModalEventosBtn) {
        cancelarModalEventosBtn.addEventListener('click', window.cerrarModalEventos);
    }
    
    if (modalEventosBackdrop) {
        modalEventosBackdrop.addEventListener('click', function(e) {
            if (e.target === modalEventosBackdrop) {
                window.cerrarModalEventos();
            }
        });
    }
});
</script>

<!-- Modal de Eventos -->
<div id="modal-eventos-backdrop" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center; padding:1rem;">
    <div style="background:#ffffff; border-radius:0.7rem; max-width:600px; width:100%; box-shadow:0 10px 30px rgba(0,0,0,0.2); max-height:90vh; overflow-y:auto;">
        <!-- Header con ícono y título -->
        <div style="background-color:#3d9eb3; padding:1rem; border-radius:0.7rem 0.7rem 0 0; position:relative;">
            <div style="display:flex; align-items:center; gap:0.75rem;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="flex-shrink:0;">
                    <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2z" fill="#ffffff"/>
                </svg>
                <div style="flex:1;">
                    <h2 style="font-size:0.95rem; font-weight:700; color:#ffffff; margin:0;">Agregar evento a la bitácora</h2>
                    <p style="font-size:0.6rem; color:#ffffff; margin:0.25rem 0 0; opacity:0.95;">Registra citas con el veterinario, medicaciones, curaciones, vacunas, desparasitaciones y comentarios.</p>
                </div>
                <button type="button" id="cerrar-modal-eventos" style="background:none; border:none; cursor:pointer; color:#ffffff; padding:0; width:28px; height:28px; display:flex; align-items:center; justify-content:center; border-radius:0.25rem; transition:background-color 0.2s; flex-shrink:0;" onmouseover="this.style.backgroundColor='rgba(255,255,255,0.2)'" onmouseout="this.style.backgroundColor='transparent'">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="#ffffff"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Contenido del formulario -->
        <div style="padding:1rem;">
            <form method="post" id="form-evento-calendario" style="display:grid; gap:0.75rem;">
                {% csrf_token %}
                <input type="hidden" name="guardar_evento_home" value="1" />
                
                <!-- Primera fila: Mascota y Fecha -->
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.75rem;">
                    <div>
                        <label for="mascota_id" style="display:block; font-size:0.55rem; font-weight:600; color:#000000; margin-bottom:0.25rem;">Mascota <span style="color:#3d9eb3;">*</span></label>
                        <select name="mascota_id" id="mascota_id" required style="width:100%; padding:0.4rem; border:1px solid #e0e0e0; border-radius:0.25rem; font-size:0.55rem; background-color:#ffffff;">
                            <option value="">Selecciona</option>
                            {% for mascota_item in todas_las_mascotas %}
                            <option value="{{ mascota_item.id }}" {% if mascota_item.id == mascota.id %}selected{% endif %}>{{ mascota_item.nombre }} ({{ mascota_item.get_especie_display }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="id_fecha_evento" style="display:block; font-size:0.55rem; font-weight:600; color:#000000; margin-bottom:0.25rem;">Fecha Evento <span style="color:#3d9eb3;">*</span></label>
                        <input type="date" name="fecha_evento" id="id_fecha_evento" required class="form-control w-full" style="width:100%; padding:0.4rem; border:1px solid #e0e0e0; border-radius:0.25rem; font-size:0.55rem;">
                        {% if evento_form.fecha_evento.errors %}
                            <p style="color:#3d9eb3; font-size:0.5rem; margin-top:0.25rem;">{{ evento_form.fecha_evento.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Resto del formulario (similar a home.html) -->
                <!-- Por brevedad, incluyo los campos principales -->
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.75rem;">
                    <div>
                        <label for="{{ evento_form.hora_evento.id_for_label }}" style="display:block; font-size:0.55rem; font-weight:600; color:#000000; margin-bottom:0.25rem;">Hora</label>
                        {{ evento_form.hora_evento }}
                    </div>
                    <div>
                        <label for="{{ evento_form.tipo_evento.id_for_label }}" style="display:block; font-size:0.55rem; font-weight:600; color:#000000; margin-bottom:0.25rem;">Tipo de Evento <span style="color:#3d9eb3;">*</span></label>
                        <select name="{{ evento_form.tipo_evento.name }}" id="{{ evento_form.tipo_evento.id_for_label }}" required style="width:100%; padding:0.4rem; border:1px solid #e0e0e0; border-radius:0.25rem; font-size:0.55rem; background-color:#ffffff;">
                            <option value="">Selecciona</option>
                            {% for choice in evento_form.tipo_evento.field.choices %}
                            {% if choice.0 %}
                            <option value="{{ choice.0 }}">{{ choice.1 }}</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div>
                    <label for="{{ evento_form.veterinario.id_for_label }}" style="display:block; font-size:0.55rem; font-weight:600; color:#000000; margin-bottom:0.25rem;">Veterinario</label>
                    <input type="text" name="{{ evento_form.veterinario.name }}" id="{{ evento_form.veterinario.id_for_label }}" value="{{ evento_form.veterinario.value|default:'' }}" placeholder="Nombre del veterinario" style="width:100%; padding:0.4rem; border:1px solid #e0e0e0; border-radius:0.25rem; font-size:0.55rem; background-color:#ffffff;">
                </div>
                
                <div>
                    <label for="{{ evento_form.descripcion.id_for_label }}" style="display:block; font-size:0.55rem; font-weight:600; color:#000000; margin-bottom:0.25rem;">Descripción</label>
                    {{ evento_form.descripcion }}
                </div>
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.75rem;">
                    <div>
                        <label for="{{ evento_form.medicacion.id_for_label }}" style="display:block; font-size:0.55rem; font-weight:600; color:#000000; margin-bottom:0.25rem;">Medicación</label>
                        {{ evento_form.medicacion }}
                    </div>
                    <div>
                        <label for="{{ evento_form.consideraciones.id_for_label }}" style="display:block; font-size:0.55rem; font-weight:600; color:#000000; margin-bottom:0.25rem;">Consideraciones</label>
                        {{ evento_form.consideraciones }}
                    </div>
                </div>
                
                <!-- Botones -->
                <div style="display:flex; justify-content:flex-end; gap:0.5rem; margin-top:0.5rem; padding-top:0.75rem; border-top:1px solid #e0e0e0;">
                    <button type="button" id="cancelar-modal-eventos" style="background-color:#e0e0e0; color:#333333; border:none; padding:0.4rem 1rem; border-radius:0.25rem; font-weight:600; cursor:pointer; font-size:0.55rem;">
                        Cancelar
                    </button>
                    <button type="submit" style="background-color:#3d9eb3; color:#ffffff; border:none; padding:0.4rem 1rem; border-radius:0.25rem; font-weight:600; cursor:pointer; font-size:0.55rem;">
                        Agregar Evento
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Editar Información Básica -->
<div id="modal-editar-info-backdrop" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center; padding:1rem;">
    <div style="background:#ffffff; border-radius:0.7rem; max-width:700px; width:100%; box-shadow:0 10px 30px rgba(0,0,0,0.2); max-height:90vh; overflow-y:auto;">
        <!-- Header con ícono y título -->
        <div style="background-color:#3d9eb3; padding:1.25rem; border-radius:0.7rem 0.7rem 0 0; position:relative;">
            <div style="display:flex; align-items:center; gap:0.75rem;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="flex-shrink:0;">
                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" fill="#ffffff"/>
                </svg>
                <div style="flex:1;">
                    <h2 style="font-size:1.1rem; font-weight:700; color:#ffffff; margin:0;">Editar Información Básica</h2>
                    <p style="font-size:0.8rem; color:#ffffff; margin:0.3rem 0 0; opacity:0.95;">Actualiza los datos de la bitácora de {{ mascota.nombre }}</p>
                </div>
                <button type="button" onclick="cerrarModalEditarInfoBasica()" style="background:none; border:none; cursor:pointer; color:#ffffff; padding:0; width:32px; height:32px; display:flex; align-items:center; justify-content:center; border-radius:0.25rem; transition:background-color 0.2s; flex-shrink:0;" onmouseover="this.style.backgroundColor='rgba(255,255,255,0.2)'" onmouseout="this.style.backgroundColor='transparent'">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="#ffffff"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Contenido del formulario -->
        <div style="padding:1.5rem;">
            <form method="post" id="form-editar-info-basica" enctype="multipart/form-data" style="display:grid; gap:1.25rem;">
                {% csrf_token %}
                <input type="hidden" name="guardar_ficha" value="1" />
                
                <!-- Foto de la Mascota -->
                <div style="padding:1rem; border:2px dashed #3d9eb3; border-radius:0.5rem; background-color:#f0f9fa;">
                    <label style="display:block; font-size:0.9rem; font-weight:600; color:#000000; margin-bottom:0.5rem;">Foto de la Mascota</label>
                    {% if mascota.foto %}
                    <div style="margin-bottom:0.75rem;">
                        <img src="{{ mascota.foto.url }}" alt="{{ mascota.nombre }}" style="width:120px; height:120px; border-radius:50%; object-fit:cover; border:3px solid #3d9eb3; display:block;">
                    </div>
                    {% endif %}
                    <input type="file" name="foto_mascota" id="foto_mascota_modal" accept="image/*" style="width:100%; padding:0.5rem; border:1px solid #3d9eb3; border-radius:0.5rem; font-size:0.85rem;">
                    <p style="margin:0.5rem 0 0; font-size:0.75rem; color:#666;">Sube una foto de tu mascota. Se mostrará en todas las visualizaciones.</p>
                </div>
                
                <!-- Tipo de Sangre -->
                {% if not tipo_sangre_oculto %}
                <div>
                    <label for="modal_tipo_sangre" style="display:block; font-size:0.9rem; font-weight:600; color:#000000; margin-bottom:0.5rem;">Tipo de Sangre</label>
                    <select name="tipo_sangre" id="modal_tipo_sangre" style="width:100%; padding:0.65rem; border:1px solid #e0e0e0; border-radius:0.5rem; font-size:0.9rem; background-color:#f5f5f5;">
                        <option value="">Seleccionar tipo</option>
                        {% for choice in ficha_form.tipo_sangre.field.choices %}
                        {% if choice.0 %}
                        <option value="{{ choice.0 }}" {% if ficha.tipo_sangre == choice.0 %}selected{% endif %}>{{ choice.1 }}</option>
                        {% endif %}
                        {% endfor %}
                    </select>
                </div>
                {% else %}
                <input type="hidden" name="tipo_sangre" value="{{ ficha.tipo_sangre|default:'' }}">
                {% endif %}
                
                <!-- Peso y Temperatura -->
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                    <div>
                        <label for="modal_peso" style="display:block; font-size:0.9rem; font-weight:600; color:#000000; margin-bottom:0.5rem;">Peso (kg)</label>
                        <input type="number" name="peso" id="modal_peso" value="{% if ficha.peso %}{{ ficha.peso }}{% endif %}" step="0.01" placeholder="Ej: 5.5" style="width:100%; padding:0.65rem; border:1px solid #e0e0e0; border-radius:0.5rem; font-size:0.9rem; background-color:#f5f5f5;">
                    </div>
                    <div>
                        <label for="modal_temperatura" style="display:block; font-size:0.9rem; font-weight:600; color:#000000; margin-bottom:0.5rem;">Temperatura (°C)</label>
                        <input type="number" name="temperatura" id="modal_temperatura" value="{% if ficha.temperatura %}{{ ficha.temperatura }}{% endif %}" step="0.01" placeholder="Ej: 38.5" style="width:100%; padding:0.65rem; border:1px solid #e0e0e0; border-radius:0.5rem; font-size:0.9rem; background-color:#f5f5f5;">
                        <div style="display:flex; align-items:center; gap:0.5rem; margin-top:0.5rem;">
                            <input type="checkbox" name="no_tengo_temperatura" id="modal_no_tengo_temperatura" {% if not ficha.temperatura %}checked{% endif %}>
                            <label for="modal_no_tengo_temperatura" style="font-size:0.85rem; color:#666; cursor:pointer;">No tengo esta información</label>
                        </div>
                    </div>
                </div>
                
                <!-- Esterilizado y Vacunas -->
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                    {% if not esterilizado_oculto %}
                    <div>
                        <label for="modal_esterilizado" style="display:block; font-size:0.9rem; font-weight:600; color:#000000; margin-bottom:0.5rem;">Esterilizado</label>
                        <select name="esterilizado" id="modal_esterilizado" style="width:100%; padding:0.65rem; border:1px solid #e0e0e0; border-radius:0.5rem; font-size:0.9rem; background-color:#f5f5f5;">
                            <option value="">Seleccionar</option>
                            <option value="True" {% if ficha.esterilizado %}selected{% endif %}>Sí</option>
                            <option value="False" {% if ficha.esterilizado == False %}selected{% endif %}>No</option>
                        </select>
                    </div>
                    {% else %}
                    <input type="hidden" name="esterilizado" value="{% if ficha.esterilizado %}True{% else %}False{% endif %}">
                    {% endif %}
                    <div>
                        <label for="modal_vacunas_estado" style="display:block; font-size:0.9rem; font-weight:600; color:#000000; margin-bottom:0.5rem;">Vacunas</label>
                        <select name="vacunas_estado" id="modal_vacunas_estado" style="width:100%; padding:0.65rem; border:1px solid #e0e0e0; border-radius:0.5rem; font-size:0.9rem; background-color:#f5f5f5;">
                            <option value="">Seleccionar</option>
                            <option value="al_dia" {% if ficha.vacunas_al_dia %}selected{% endif %}>Al día</option>
                            <option value="otra" {% if ultima_vacuna_nombre and not ficha.vacunas_al_dia %}selected{% endif %}>Otra</option>
                            <option value="no" {% if ficha.vacunas_al_dia == False and not ultima_vacuna_nombre %}selected{% endif %}>No</option>
                        </select>
                    </div>
                </div>
                
                <!-- Alergias -->
                <div>
                    <label for="modal_alergias" style="display:block; font-size:0.9rem; font-weight:600; color:#000000; margin-bottom:0.5rem;">Alergias</label>
                    <textarea name="alergias" id="modal_alergias" rows="3" placeholder="Describe las alergias conocidas de tu mascota" style="width:100%; padding:0.65rem; border:1px solid #e0e0e0; border-radius:0.5rem; font-size:0.9rem; background-color:#f5f5f5; font-family:inherit; resize:vertical;">{% if ficha.alergias %}{{ ficha.alergias }}{% endif %}</textarea>
                </div>
                
                <!-- Condiciones Crónicas -->
                <div>
                    <label for="modal_condiciones_cronicas" style="display:block; font-size:0.9rem; font-weight:600; color:#000000; margin-bottom:0.5rem;">Condiciones Crónicas</label>
                    <textarea name="condiciones_cronicas" id="modal_condiciones_cronicas" rows="3" placeholder="Ej: Diabetes, carditis, problemas cardiacos" style="width:100%; padding:0.65rem; border:1px solid #e0e0e0; border-radius:0.5rem; font-size:0.9rem; background-color:#f5f5f5; font-family:inherit; resize:vertical;">{% if ficha.condiciones_cronicas %}{{ ficha.condiciones_cronicas }}{% endif %}</textarea>
                </div>
                
                <!-- Medicamentos Actuales -->
                <div>
                    <label for="modal_medicamentos_actuales" style="display:block; font-size:0.9rem; font-weight:600; color:#000000; margin-bottom:0.5rem;">Medicamentos Actuales</label>
                    <textarea name="medicamentos_actuales" id="modal_medicamentos_actuales" rows="3" placeholder="Medicamentos, dosis, frecuencia..." style="width:100%; padding:0.65rem; border:1px solid #e0e0e0; border-radius:0.5rem; font-size:0.9rem; background-color:#f5f5f5; font-family:inherit; resize:vertical;">{% if ficha.medicamentos_actuales %}{{ ficha.medicamentos_actuales }}{% endif %}</textarea>
                </div>
                
                <!-- Botones -->
                <div style="display:flex; justify-content:flex-end; gap:0.75rem; margin-top:1rem; padding-top:1rem; border-top:1px solid #e0e0e0;">
                    <button type="button" onclick="cerrarModalEditarInfoBasica()" style="background-color:#e0e0e0; color:#333333; border:none; padding:0.65rem 1.5rem; border-radius:0.5rem; font-weight:600; cursor:pointer; font-size:0.9rem;">
                        Cancelar
                    </button>
                    <button type="submit" style="background-color:#3d9eb3; color:#ffffff; border:none; padding:0.65rem 1.5rem; border-radius:0.5rem; font-weight:600; cursor:pointer; font-size:0.9rem;">
                        Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
